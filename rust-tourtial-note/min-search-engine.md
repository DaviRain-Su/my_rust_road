# 自制搜索引擎

## ch1 搜索引擎是如何工作的

### 1-1 理解搜索引擎的构成

#### 什么是搜索引擎

搜索引擎是一类系统或软件的统称，作用是从文档的集合中查找（检索）出匹配信息需求（查询）的文档，信息需求是由单词、问题等构成的。

”全文搜索引擎”是指“全文”指的就是全部的句子，当检索的对象为“由文本构成的文档中的全部的句子”时，对于该文档进行得检索就称为全文搜索。而实现了这种全文搜索的系统就是全文搜索引擎
（全文搜索系统 Full-text Search Engine）


#### 构成搜索引擎的组件

搜索引擎一般由以下4个组件构成

- 索引管理系统 Index Manger 
- 索引检索器 Index Searcher
- 索引构建器 Indexer
- 文档管理器 Document Manger


* 索引管理器 

索引管理器组件的作用是管理带有索引结构的数据，索引结构是一种用于进行高速检索的数据结构。
对索引的访问也是通过索引管理器进行的。

索引管理器通常是将索引作为**二级存储**上的二进制文件来进行管理的。还经常会通过保存进行过压缩的索引来减少从二进制存储加载的数据量，提升检索处理效率的目的.

* 索引检索器

索引检索器是利用索引进行全文搜索处理的组件，索引检索器根据来自检索影城程序用户的查询，协同索引管理器进行检索处理。在大多数情况下，索引检索器都会根据某种标准对查询相匹配的检索结果排序，并将排在前面的结果返回给应用程序。

* 索引构建器

索引构建器是从作为检索对象的文本文档中生成索引的组件。所以构建器会先通过解析将文本
文档分解为单词序列，然后在将该单词序列转为索引结构。在搜索引擎中，将生成索引的环节称为索引构建(Index Construction)

* 文档管理器

文档管理器是管理文档数据库的组件，文档数据库中存储着作为检索对象的文档。 文档管理器会先从文档数据库中取出与查询相匹配的文档，然后再跟进需要从该文档中提取出一部分内容作为摘要。

文档管理器的结构很简单，只是对应着文档特定的ID来保存文档的内容。
有人将数据库管理系统和基于二级存储的数据库管理系统等用作完档管理系统。

由文档管理器管理的文档数据库既可以在构建索引的阶段随索引一同构建，也可以提前构建。



#### 与搜索引擎相关的组件

爬虫

爬虫是用于收集Web上Html文件等文档的系统。


搜索排序系统

以Google的PageRank系统为代表的搜索排序系统是给作为检索对象的问文档打分的系统。
例如在Web搜索中，通常会以考量了查询与文档的关联性以及文档的热门度后得出的分数为
基准，将检索结果排序后提供给应用程序的用户。搜索排序系统正是用于目的的，能（机械的）
算出文档热门度的系统。



### 1-2 实现快速全文搜索的索引结构

#### 全文搜索的两种方法

- 利用全扫描进行全文搜索

- 利用索引进行全文搜索

* 利用全扫描进行全文搜索

是从头到尾扫描作为检索对象的文档，以次来搜索要检索的字符串。 
缺点：只适用于处理少量或暂时性的文档
还有一些高级算法， KMP算法，BM算法。

* 利用索引进行全文搜索

利用索引的方法，则需要事先为文档建立索引，然后利用索引来搜索要检索的字符串
虽然需要事先建立索引需要花费时间，但是有点是即使文档的数量增加，检索速度也不会大幅下降。
因此，一般认为这种方法更适合处理大量的文档，搜索引起一般也会采用这种方法。

大部分的搜索引擎的索引结构采用的都是倒排索引的索引结构.

#### 倒排索引结构

#### 倒排索引的构建方法

将表示“在那一页上使用了那个单词”的表格转换为"那个单词出现了那一页上“的表格，就可以制作出倒排索引了。之所以称这种索引为倒排索引，是由于刚刚进行过的交换表格行，列的操作叫做”倒排“。

#### 倒排索引中的术语 

在生成的倒排索引中，我们建立起了页中的单词和页的对应关系，也就是说，我们是把页当成了构建索引的单位。之所以这样做，是因为在翻阅图书时，人们常常是以”页”作为单位的。

对于Web上的Html文档，可以将一个HTML网页作为构建索引的单位。 对于邮件，可以将一封邮件
作为构建索引的单位。

在全文索引中，将构建索引的单位统称为“文档”， 将文档的表示信息称为“文档编号”， 文档编号类似图书的页码，用于唯一的标识某个文档。因为。所谓倒排索引就是“把单词和单词所在文档的编号对应起来的表格”。

在倒排索引中，将表示单词和文档编号对应关系的信息称为倒排项。
将各个单词的倒排项的集合称为倒排列表。
例如， 单词search的倒排想是P1,P2，倒排列表时P1，P2的集合，记作“P1, P2"


### 1-3 深入理解倒排索引

#### 倒排索引=词典+倒排文件

倒排索引是由单词的集合”词典“和倒排列表的集合”倒排文件“构成的，

词典    | 倒排列表
search | P1, P2,

#### 从倒排索引中查找单词

Q: 从倒排索引中查找单词的方法？

A: 若要从倒排索引中查找出包含了某个单词的文档，只需要从词典中找到该单词，然后获取与之对应的倒排列表，最后从倒排列表中获取文档编号。

Q: 如何查找同时包含多个单词的文档呢？
A:查找时只需要从词典中找出各个单词，然后分别获取这些单词的倒排列表并加在一起，由此计算出包含在各个倒排列表中的文档编号的交集。
例如：查找search engine, search 的倒排列表为1, 2。 engine的倒排列表为1, 则两者的交集为P1(1).同时包含这两个单词的文档是P1。

#### 将单词的位置信息加入倒排文件中

之前的倒排文件称为”文档级别的倒排文件“， 还有一种称为”单词级别的倒排文件“， 这种倒排文件中不仅带有有关单词出现在了那个文档中的信息，还带有出现在了文档中的什么位置（从开头数是
第几个单词）这一信息。

示例：DocID; Offset1, Offsert2, ..., OffsetN 

例如单词search是文档1中的第三个单词，是文档2中的第2个单词，因此其倒排列表是
search: D1;3, D2; 2

**从倒排索引中查找短语，或是计算检索结果中文档的得分等场景中都会用到这种单词的位置信息。**

#### 从倒排索引中查找短语

查找连续的短语信息，search engine, 要想从倒排索引中查找短语，就需要使用单词级别的倒排文件。  

查询步骤与文档级别的类似，但是在求出交集后，还需要确认search， engine是否相邻出现。


### 1-4 制作中文文档的倒排索引

英文单词之间有空白，可以用空白划分句子，就可以提取出句子中的单词。但是在中文的句子中，由于各单词是词间不留空白连续书写的，所以就需要使用不同于英文的方法。